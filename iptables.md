# iptables使用指南

iptables是用于设置、维护、观察Linux内核中的IP包过滤规则的工具。

内核中有很多种不同类型的表可以设置。每个表，含有很多内置的规则链，也可以包含用户定义的规则链。

每一个链是一个规则列表，可以用来匹配一系列包。

每一条规则定义了当一个包匹配了当前规则时做什么。

我们把匹配时做的事情称为目标。


## 目标(Targets)

一条防火墙规则会定义包的过滤条件，还有目标。

如果数据包没有匹配到规则，内核会检测链中的下一条规则。

如果匹配，下一条规则可以由目标的值指定。

可以是一个用户定义链的名称或是ACCEPT, DROP, QUOTE或RETURN目标。

目标：

* ACCEPT 	表示包可以通过
* DROP		表示包会被丢弃
* QUEUE		表示把包发送到用户空间（如何发送到用户空间，因队列处理程序而异。内核包含ip_queue处理程序）
* RETURN	表示停止遍历该链表，并在上一个链的下一条规则处恢复。如果已经抵达了内置链的尾部，或是已经抵达内置链的一个RETURN目标处，则链策略将决定包的命运。

## 表(Tables)

目前iptables中有3种互相独立的表。（哪个表是当前表，由内核配置和当前模块决定）

-t --table <表名>

这个选项定义了iptables命令要操作哪一个表。如果内核配置了自动模块加载，如果该表对应的模块没有加载，内核会尝试加载相关模块。filter表为缺省的表。

表有：

filter表:

这是缺省的表，它包含了3条内置链：

* INPUT: 	用于发送到本地的包。
* FORWARD: 	用于处理通过盒子路由的包
* OUTPUT：	用于处理本地产生的包

nat表：

当一个新连接发生时，这个表会被用到。
它包含三条内置链：
* PREROUTING	用于改变包，在他到达的时候
* OUTPUT	在路由前，在路由前
* POSTROUTING	改变包在路由后，发送前

mangle表：

这个表是用于特定包修改的。

目前包含两条内置链表:
* PREROUTING 	用于接收到的数据包，在路由前改变数据包。
* OUTPUT	用于本地产生的数据包， 
*
raw表：

这个表主要用于结合NOTRACK目标配置连接跟踪豁免权。

raw表在netfilter中会以更高优先级注册。并且这个调用会在ip_conntrack, 或其他IP表前调用。
他提供了两条内置链：
* PREROUTING	在包到达网卡时调用
* OUTPUT	为本地进程产生的包调用


## 命令

-A, --append <链> <规则描述>

	在选定的链尾部添加一或多条规则。
	当一个源或目标的名字被解释为多个地址时，
	这个规则会绑定所有可能的地址组合。

	规则描述是由许多iptables选项来组成的。

-D，--delete <链> <规则描述>
-D，--delete <链> <规则描述>

	从链中删除指定规则

-I, --insert <链> [<规则编号>] <规则描述>
	
	在指定位置插入规则，规则编号缺省为1，也就是缺省情况下，规则会在链的头部插入。


-R，--replace <链> <规则编号> <规则描述>
	
	替换指定链中指定位置的规则

-L, --list [<链>]
	
	显示链中的所有规则，如果没有链参数，则显示所有链上的规则。


## 参数

-p, --protocol [!] <协议>
	
	描述要检查的规则或数据包的协议类型。
	指定的协议可以是tcp、udp、icmp其中之一，或是全部。
	也可以代表协议的数字。协议名可以是/etc/protocols文件中的任何一种协议。
	！表示否定的意思。！协议表示反转测试的结果。数值0表示所有。当这个选项被忽略时，
	缺省协议是all。

-m, --match <匹配模块>
	
	用于设定需要加载的扩展匹配模块

-s, --source [!] <地址>/[<掩码>]

	指定源。地址可以是网络名或主机名，不过更合适的是一个网络IP地址附带掩码，或一个普通的IP地址。
	掩码可以是网络掩码或是数值指定网络掩码对应二进制的左边1的数量。
	所以掩码24等于255.255.255.0。
	！还是反转测试结果的意思

	
-d, --destination [!]<地址>/[<掩码>]

	目标规范。格式同上。


-n, --numeric

	数字化输出。也就是IP地址和端口会以阿拉伯数字的方式显示。如果不加-n选项，iptables会尝用主机名、网络名、
	或服务的方式显示。

-i, --in-interface [!]<网卡名>
	
	设置输入包的网卡名。用于INPUT、FORWARD、PREROUTING链中。

-j, --jump <目标>

	设置规则的目标

-g，--goto <链>
	
	与jump不同，goto后不会继续执行当前链


## 匹配扩展模块

iptables 可以使用不同的扩展的包匹配模块。这些扩展模块可以通过两种方式加载。

1. 隐藏的方式加载。当-p或者--protocol配置后自动加载协议相关模块

2. 显示加载。-m或--match选项后面跟对应的匹配模块名

做了这些后，更多的额外的命令行会变成可用， 具体取决于特定模块。你可以配置多个扩展匹配模块在一行，
你还可以在-p 协议名 或 -m 模块名后加 -h 来获取对应模块的选项信息。

## tcp模块

--sport, --source-port [!]<端口>[:<端口>]

	指定源端口或端口区间。冒号":", 其实就是区间符号。
	
	
--dport, --destination-prot [!]<端口>[:<端口>]

	指定目标端口或端口区间。如果需指定区间，需要使用冒号":"来分隔区间开始端口和区间结束端口。

--tcp-flags [!]<匹配掩码> <匹配项>

	匹配掩码就是需要匹配的tcp标志位。匹配项就是指定匹配掩码中为1（需要设置的项）。

	标志位包括： SYN ACK FIN RST URG PSH ALL NONE

## 使用经验

1. 模拟指定ip断网。

	iptables -A INPUT -s <ip地址> -j DROP

	在iptables缺省的filter表上的INPUT链上添加一条规则: 源为ip地址， 执行包丢弃工作。


